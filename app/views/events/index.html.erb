<% content_for :map_script do %>
  <script type="text/javascript"
          src="https://maps.googleapis.com/maps/api/js?v=3.exp">
  </script>

  <script>
    var denver = new google.maps.LatLng(39.740009, -104.992302);

    function initialize() {

      var mapCanvas = document.getElementById('mapContainer');
      var mapOptions = {
        center: denver,
        zoom: 12,
        disableDefaultUI: true,
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };

      var map = new google.maps.Map(mapCanvas, mapOptions);


      var promiseOfResult = $.getJSON("/events");
          var infowindow = new google.maps.InfoWindow({});

      var generateMarkers = function (music_events) {
        $.each(music_events, function (i, music_event) {

          var lat = music_event.venue.location.split(",")[0];
          var lng = music_event.venue.location.split(",")[1];

          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(lat, lng),
            title: music_event.name,
            animation: google.maps.Animation.DROP,
            map: map
          });


          var eventInfo = '<div class="info_window">' +
            '<p>' + music_event.name + '</p><br>' +
            '<p>' + music_event.venue.name + '</p><br>' +
            '<a href="' + music_event.tickets + '" class="button">Tickets</a>' +
            '</div>';


          google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent(eventInfo);
            infowindow.open(map, marker);
          });
        });
      };

      promiseOfResult.success(generateMarkers);
    }

    google.maps.event.addDomListener(window, 'load', initialize);
  </script>
<% end %>

<% content_for :main do %>
  <div id="mapContainer">
  </div>
<% end %>
